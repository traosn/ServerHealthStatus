<!DOCTYPE html>
<html>
<head>
    <title>Server Health Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .progress { height: 25px; min-width: 100px; }
        .progress-bar { line-height: 25px; font-family: monospace; }
        .table > tbody > tr > td { vertical-align: middle; }
        #lastUpdate { font-size: 0.9em; color: #666; }
        #countdown { font-weight: bold; }
        .tooltip-inner { max-width: 350px; text-align: left; }
        .event-link { cursor: pointer; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="row mb-3">
            <div class="col">
                <h2>Server Health Dashboard</h2>
                <div id="lastUpdate">Last Update: <span id="updateTime"></span> (Refreshing in <span id="countdown">30</span>s)
                    <button id="pauseButton" class="btn btn-sm btn-outline-secondary">Pause</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Server</th>
                                <th>CPU</th>
                                <th>Memory</th>
                                <th>Disk</th>
                                <th>Uptime</th>
                                <th>Critical Events</th>
                                <th>Status</th>
                                <th>Last Update</th>
                            </tr>
                        </thead>
                        <tbody id="serverData">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
    const REFRESH_INTERVAL = 30; // seconds
    let countdown = REFRESH_INTERVAL;
    let isPaused = false;

    // Initialize tooltips
    function initTooltips() {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true,
                container: 'body'
            });
        });
    }

    // Create progress bar
    function createProgressBar(value, max, type = "primary", text = "") {
        const percent = Number(value).toFixed(1);  // Keep 1 decimal place
        const width = Math.round((value / max) * 100);
        const display = text || `${percent.toString().padStart(4, ' ')}%`;  // Pad to minimum 4 chars (nn.n%)
        return `<div class="progress" style="min-width: 100px;">
                    <div class="progress-bar bg-${type}" role="progressbar" 
                         style="width: ${width}%" aria-valuenow="${width}" 
                         aria-valuemin="0" aria-valuemax="100">
                         <span style="font-family: monospace; white-space: pre;">${display}</span>
                    </div>
                </div>`;
    }

    // Calculate server status based on last update time
    function getServerStatus(lastPollString) {
        try {
            // Parse the LastPoll timestamp (format: "MM/dd HH:mm")
            const now = new Date();
            const currentYear = now.getFullYear();
            const [datePart, timePart] = lastPollString.split(' ');
            const [month, day] = datePart.split('/');
            const [hour, minute] = timePart.split(':');
            
            const lastPoll = new Date(currentYear, month - 1, day, hour, minute);
            const minutesAgo = Math.floor((now - lastPoll) / (1000 * 60));
            
            let status, tooltip, icon, color;
            
            if (minutesAgo <= 10) {
                status = 'good';
                icon = 'ðŸŸ¢';
                color = 'success';
                tooltip = `Online - Last seen ${minutesAgo} minute${minutesAgo !== 1 ? 's' : ''} ago`;
            } else if (minutesAgo <= 20) {
                status = 'warning';
                icon = 'ðŸŸ¡';
                color = 'warning';
                tooltip = `Warning - Last seen ${minutesAgo} minutes ago (missed 1-2 updates)`;
            } else {
                status = 'critical';
                icon = 'ðŸ”´';
                color = 'danger';
                tooltip = `Critical - Last seen ${minutesAgo} minutes ago (missed 3+ updates)`;
            }
            
            return {
                status: status,
                icon: icon,
                color: color,
                tooltip: tooltip,
                minutesAgo: minutesAgo
            };
        } catch (error) {
            return {
                status: 'unknown',
                icon: 'â“',
                color: 'secondary',
                tooltip: 'Unable to determine status',
                minutesAgo: 999
            };
        }
    }

    // Update the dashboard
    async function updateDashboard() {
        try {
            const serverData = document.getElementById('serverData');
            serverData.innerHTML = '';
            
            // Get list of files in the repository
            const response = await fetch('https://api.github.com/repos/traosn/ServerHealthStatus/contents/');
            const files = await response.json();
            
            // Collect all server data first for sorting
            const servers = [];
            
            for (const file of files) {
                if (file.name.endsWith('_status.json')) {
                    const dataResponse = await fetch(file.download_url);
                    const data = await dataResponse.json();
                    
                    // Create tooltips
                    const cpuTooltip = data.CPUTooltip || `CPU Usage: ${data.CPUPercent}%`;
                    const ramTooltip = `Total: ${data.RAMTotalGB} GB\nUsed: ${data.RAMUsedGB} GB\nFree: ${data.RAMFreeGB} GB`;
                    const diskTooltip = data.DiskTooltip || `Free Space: ${data.DiskFreePercent}%`;
                    const uptimeTooltip = data.UptimeTooltip || data.Uptime;
                    
                    // Load events count from events.json
                    let eventSummary = 'Loading...';
                    try {
                        const serverName = file.name.replace('_status.json', '');
                        const eventsResponse = await fetch(`${serverName}_events.json`);
                        const eventsData = await eventsResponse.json();
                        const eventCount = eventsData.Events ? eventsData.Events.length : 0;
                        
                        if (eventCount > 0) {
                            eventSummary = `<a href="${serverName}_events.html" target="_blank">${eventCount} event${eventCount > 1 ? 's' : ''}</a>`;
                        } else {
                            eventSummary = 'No events';
                        }
                    } catch (error) {
                        console.error('Error loading events:', error);
                        eventSummary = 'Error loading events';
                    }

                    // Calculate server status
                    const serverStatus = getServerStatus(data.LastPoll);

                    // Calculate status colors for metrics
                    const cpuStatus = data.CPUPercent > 90 ? 'danger' : data.CPUPercent > 80 ? 'warning' : 'success';
                    const ramStatus = data.RAMUsedPercent > 90 ? 'danger' : data.RAMUsedPercent > 80 ? 'warning' : 'success';
                    const diskStatus = data.DiskFreePercent < 10 ? 'danger' : data.DiskFreePercent < 20 ? 'warning' : 'success';

                    // Store server data for sorting
                    servers.push({
                        customer: data.Customer || 'Unknown',
                        computer: data.Computer,
                        data: data,
                        cpuTooltip: cpuTooltip,
                        ramTooltip: ramTooltip,
                        diskTooltip: diskTooltip,
                        uptimeTooltip: uptimeTooltip,
                        eventSummary: eventSummary,
                        serverStatus: serverStatus,
                        cpuStatus: cpuStatus,
                        ramStatus: ramStatus,
                        diskStatus: diskStatus
                    });
                }
            }
            
            // Sort servers: Customer -> Status (critical first) -> Server name
            servers.sort((a, b) => {
                // First by customer
                if (a.customer !== b.customer) {
                    return a.customer.localeCompare(b.customer);
                }
                // Then by status (critical first)
                const statusOrder = { 'critical': 0, 'warning': 1, 'good': 2, 'unknown': 3 };
                if (a.serverStatus.status !== b.serverStatus.status) {
                    return statusOrder[a.serverStatus.status] - statusOrder[b.serverStatus.status];
                }
                // Finally by server name
                return a.computer.localeCompare(b.computer);
            });
            
            // Create table rows
            servers.forEach(server => {
                const row = `<tr>
                    <td>${server.customer}</td>
                    <td>${server.data.Computer}</td>
                    <td data-bs-toggle="tooltip" title="${server.cpuTooltip}">
                        ${createProgressBar(server.data.CPUPercent, 100, server.cpuStatus, server.data.CPUPercent + '%')}
                    </td>
                    <td data-bs-toggle="tooltip" title="${server.ramTooltip}">
                        ${createProgressBar(server.data.RAMUsedGB, server.data.RAMTotalGB, server.ramStatus, Math.round(server.data.RAMUsedPercent) + '%')}
                    </td>
                    <td data-bs-toggle="tooltip" title="${server.diskTooltip}">
                        ${createProgressBar(server.data.DiskFreePercent, 100, server.diskStatus, `${server.data.DiskFreePercent}% free of ${server.data.TotalSize}`)}
                    </td>
                    <td data-bs-toggle="tooltip" title="${server.uptimeTooltip}">${server.data.Uptime}</td>
                    <td>${server.eventSummary}</td>
                    <td data-bs-toggle="tooltip" title="${server.serverStatus.tooltip}">
                        <span class="text-${server.serverStatus.color}">${server.serverStatus.icon}</span>
                    </td>
                    <td>${server.data.LastPoll}</td>
                </tr>`;
                
                serverData.innerHTML += row;
            });
            
            // Update last refresh time
            document.getElementById('updateTime').textContent = new Date().toLocaleString();
            initTooltips();
            
        } catch (error) {
            console.error('Error updating dashboard:', error);
            const serverData = document.getElementById('serverData');
            serverData.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-danger">
                        <div class="alert alert-danger">
                            Error loading data: ${error.message}<br>
                            Please check if the repository is accessible.
                        </div>
                    </td>
                </tr>`;
        }
    }

    // Handle countdown
    function updateCountdown() {
        if (!isPaused) {
            countdown--;
            document.getElementById('countdown').textContent = countdown;
            if (countdown <= 0) {
                countdown = REFRESH_INTERVAL;
                updateDashboard();
            }
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize pause button
        document.getElementById('pauseButton').addEventListener('click', function() {
            isPaused = !isPaused;
            this.textContent = isPaused ? 'Resume' : 'Pause';
            this.classList.toggle('btn-outline-secondary');
            this.classList.toggle('btn-secondary');
        });

        // Start updates
        updateDashboard();
        setInterval(updateCountdown, 1000);
    });
    </script>
</body>
</html>