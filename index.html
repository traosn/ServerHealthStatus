<!DOCTYPE html>
<html>
<head>
    <title>Server Health Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .progress { height: 25px; }
        .progress-bar { line-height: 25px; }
        .table > tbody > tr > td { vertical-align: middle; }
        #lastUpdate { font-size: 0.9em; color: #666; }
        #countdown { font-weight: bold; }
        .tooltip-inner { max-width: 350px; text-align: left; }
        .event-link { cursor: pointer; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="row mb-3">
            <div class="col">
                <h2>Server Health Dashboard</h2>
                <div id="lastUpdate">Last Update: <span id="updateTime"></span> (Refreshing in <span id="countdown">30</span>s)
                    <button id="pauseButton" class="btn btn-sm btn-outline-secondary">Pause</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Server</th>
                                <th>CPU</th>
                                <th>Memory</th>
                                <th>Disk</th>
                                <th>Uptime</th>
                                <th>Critical Events</th>
                                <th>Last Update</th>
                            </tr>
                        </thead>
                        <tbody id="serverData">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Critical Events</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="eventServer" class="h6 mb-3"></div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="eventDetails">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Source</th>
                                    <th>Event ID</th>
                                    <th>Message</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const REFRESH_INTERVAL = 30; // seconds
    let countdown = REFRESH_INTERVAL;
    let isPaused = false;
    let eventModal;

    // Initialize tooltips
    function initTooltips() {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true,
                container: 'body'
            });
        });
    }

    // Create progress bar
    function createProgressBar(value, max, type = "primary", text = "") {
        const percent = Math.round((value / max) * 100);
        const display = text || `${percent}%`;
        return `<div class="progress">
                    <div class="progress-bar bg-${type}" role="progressbar" 
                         style="width: ${percent}%" aria-valuenow="${percent}" 
                         aria-valuemin="0" aria-valuemax="100">${display}</div>
                </div>`;
    }

    // Show event details
    function showEventDetails(serverName, events) {
        document.getElementById('eventServer').textContent = `Server: ${serverName}`;
        const tbody = document.querySelector('#eventDetails tbody');
        tbody.innerHTML = '';
        
        events.forEach(event => {
            const row = document.createElement('tr');
            const time = new Date(event.TimeCreated).toLocaleString();
            row.innerHTML = `
                <td>${time}</td>
                <td>${event.Source}</td>
                <td>${event.Id}</td>
                <td>${event.Message}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="researchEvent('${event.Id}', '${event.ErrorCode || ''}', '${event.UpdateTitle || ''}', '${event.Source}', '${event.Message.replace(/'/g, "\\'")}')"
                    >Research</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        eventModal.show();
    }
    
    // Research specific event
    function researchEvent(eventId, errorCode, updateTitle, source, message) {
        const row = event.target.closest('tr');
        const actionCell = row.querySelector('td:last-child');
        const originalContent = actionCell.innerHTML;
        
        actionCell.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>';
        
        // Simulate AI research (placeholder)
        setTimeout(() => {
            actionCell.innerHTML = '<div class="alert alert-info p-2 mb-0">This is a placeholder for the AI response. The actual implementation will search for solutions using the Gemini API.</div>';
            setTimeout(() => actionCell.innerHTML = originalContent, 3000);
        }, 1500);
    }

    // Update the dashboard
    async function updateDashboard() {
        try {
            const serverData = document.getElementById('serverData');
            serverData.innerHTML = '';
            
            // Get list of files in the repository
            const response = await fetch('https://api.github.com/repos/traosn/ServerHealthStatus/contents/');
            const files = await response.json();
            
            // Process each status file
            for (const file of files) {
                if (file.name.endsWith('_status.json')) {
                    const dataResponse = await fetch(file.download_url);
                    const data = await dataResponse.json();
                    
                    // Create tooltips
                    const cpuTooltip = data.CPUTooltip || `CPU Usage: ${data.CPUPercent}%`;
                    const ramTooltip = `Total: ${data.RAMTotalGB} GB\nUsed: ${data.RAMUsedGB} GB\nFree: ${data.RAMFreeGB} GB`;
                    const diskTooltip = data.DiskTooltip || `Free Space: ${data.DiskFreePercent}%`;
                    const uptimeTooltip = data.UptimeTooltip || data.Uptime;
                    
                    // Create event summary
                    let eventSummary = '';
                    const eventCount = data.CriticalEvents ? data.CriticalEvents.length : 0;
                    if (eventCount > 0) {
                        eventSummary = `<a href="#" class="event-link" onclick="showEventDetails('${data.Computer}', ${JSON.stringify(data.CriticalEvents).replace(/'/g, "\\'")})">${eventCount} event${eventCount > 1 ? 's' : ''}</a>`;
                    } else {
                        eventSummary = 'No events';
                    }

                    // Calculate status colors
                    const cpuStatus = data.CPUPercent > 90 ? 'danger' : data.CPUPercent > 80 ? 'warning' : 'success';
                    const ramStatus = data.RAMUsedPercent > 90 ? 'danger' : data.RAMUsedPercent > 80 ? 'warning' : 'success';
                    const diskStatus = data.DiskFreePercent < 10 ? 'danger' : data.DiskFreePercent < 20 ? 'warning' : 'success';

                    // Create table row
                    const row = `<tr>
                        <td>${data.Computer}</td>
                        <td data-bs-toggle="tooltip" title="${cpuTooltip}">
                            ${createProgressBar(data.CPUPercent, 100, cpuStatus, data.CPUPercent + '%')}
                        </td>
                        <td data-bs-toggle="tooltip" title="${ramTooltip}">
                            ${createProgressBar(data.RAMUsedGB, data.RAMTotalGB, ramStatus, Math.round(data.RAMUsedPercent) + '%')}
                        </td>
                        <td data-bs-toggle="tooltip" title="${diskTooltip}">
                            ${createProgressBar(data.DiskFreePercent, 100, diskStatus, data.DiskFreePercent + '% free')}
                        </td>
                        <td data-bs-toggle="tooltip" title="${uptimeTooltip}">${data.Uptime}</td>
                        <td>${eventSummary}</td>
                        <td>${data.LastPoll}</td>
                    </tr>`;
                    
                    serverData.innerHTML += row;
                }
            }
            
            // Update last refresh time
            document.getElementById('updateTime').textContent = new Date().toLocaleString();
            initTooltips();
            
        } catch (error) {
            console.error('Error updating dashboard:', error);
            const serverData = document.getElementById('serverData');
            serverData.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <div class="alert alert-danger">
                            Error loading data: ${error.message}<br>
                            Please check if the repository is accessible.
                        </div>
                    </td>
                </tr>`;
        }
    }

    // Handle countdown
    function updateCountdown() {
        if (!isPaused) {
            countdown--;
            document.getElementById('countdown').textContent = countdown;
            if (countdown <= 0) {
                countdown = REFRESH_INTERVAL;
                updateDashboard();
            }
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize modal
        eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        
        // Initialize pause button
        document.getElementById('pauseButton').addEventListener('click', function() {
            isPaused = !isPaused;
            this.textContent = isPaused ? 'Resume' : 'Pause';
            this.classList.toggle('btn-outline-secondary');
            this.classList.toggle('btn-secondary');
        });

        // Start updates
        updateDashboard();
        setInterval(updateCountdown, 1000);
    });
    </script>
</body>
</html>